<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RHCSA Practice Labs</title>
    <style>
        :root {
            --rh-red: #EE0000;
            --rh-red-dark: #A30000;
            --rh-black: #151515;
            --rh-gray-dark: #1F1F1F;
            --rh-gray: #3C3F42;
            --rh-gray-light: #6A6E73;
            --rh-white: #FFFFFF;
            --rh-blue: #0066CC;
            --rh-green: #3E8635;
            --rh-orange: #F0AB00;
            --rh-cyan: #009596;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Red Hat Display', 'Segoe UI', system-ui, sans-serif;
            background: var(--rh-black);
            color: var(--rh-white);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Top Header Bar */
        .header {
            background: var(--rh-gray-dark);
            border-bottom: 3px solid var(--rh-red);
            padding: 0.75rem 1.5rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 700;
            font-size: 1.1rem;
        }

        .logo-icon {
            width: 28px;
            height: 28px;
            background: var(--rh-red);
            border-radius: 2px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.9rem;
        }

        .header-center {
            display: flex;
            align-items: center;
            gap: 2rem;
        }

        .vm-status {
            display: flex;
            gap: 1rem;
        }

        .vm-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.4rem 0.75rem;
            background: var(--rh-gray);
            border-radius: 4px;
            font-size: 0.85rem;
        }

        .vm-indicator .dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--rh-gray-light);
        }

        .vm-indicator .dot.ok { background: var(--rh-green); }
        .vm-indicator .dot.fail { background: var(--rh-red); }
        .vm-indicator .dot.pending { background: var(--rh-orange); }

        .timer-display {
            font-family: 'Consolas', monospace;
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--rh-white);
            padding: 0.25rem 1rem;
            background: var(--rh-gray);
            border-radius: 4px;
        }

        .timer-display.warning {
            color: var(--rh-orange);
            animation: pulse 1s infinite;
        }

        .timer-display.critical {
            color: var(--rh-red);
            animation: pulse 0.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        .header-right {
            display: flex;
            gap: 0.75rem;
        }

        /* Main Layout */
        .main-container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* Left Sidebar - Task List */
        .sidebar {
            width: 320px;
            background: var(--rh-gray-dark);
            border-right: 1px solid var(--rh-gray);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .sidebar-header {
            padding: 1rem;
            border-bottom: 1px solid var(--rh-gray);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .sidebar-header h2 {
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--rh-gray-light);
        }

        .task-count {
            font-size: 0.85rem;
            color: var(--rh-gray-light);
        }

        .task-list {
            flex: 1;
            overflow-y: auto;
            padding: 0.5rem;
        }

        .task-item {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            padding: 0.75rem;
            margin-bottom: 0.25rem;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.15s;
            border-left: 3px solid transparent;
        }

        .task-item:hover {
            background: var(--rh-gray);
        }

        .task-item.active {
            background: var(--rh-gray);
            border-left-color: var(--rh-red);
        }

        .task-item.completed {
            opacity: 0.6;
        }

        .task-number {
            width: 24px;
            height: 24px;
            background: var(--rh-gray);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 600;
            flex-shrink: 0;
        }

        .task-item.completed .task-number {
            background: var(--rh-green);
        }

        .task-item.failed .task-number {
            background: var(--rh-red);
        }

        .task-info {
            flex: 1;
            min-width: 0;
        }

        .task-title {
            font-size: 0.9rem;
            margin-bottom: 0.25rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .task-category {
            font-size: 0.75rem;
            color: var(--rh-cyan);
            text-transform: capitalize;
        }

        /* Main Content Area */
        .content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .content-header {
            padding: 1.5rem 2rem;
            border-bottom: 1px solid var(--rh-gray);
            background: var(--rh-gray-dark);
        }

        .content-header h1 {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .content-header .meta {
            display: flex;
            gap: 1.5rem;
            font-size: 0.85rem;
            color: var(--rh-gray-light);
        }

        .content-body {
            flex: 1;
            overflow-y: auto;
            padding: 2rem;
        }

        /* Buttons */
        .btn {
            padding: 0.6rem 1.25rem;
            border: none;
            border-radius: 4px;
            font-family: inherit;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: var(--rh-red);
            color: white;
        }

        .btn-primary:hover {
            background: var(--rh-red-dark);
        }

        .btn-secondary {
            background: var(--rh-gray);
            color: white;
        }

        .btn-secondary:hover {
            background: #4a4d50;
        }

        .btn-success {
            background: var(--rh-green);
            color: white;
        }

        .btn-success:hover {
            background: #2e6a28;
        }

        .btn-outline {
            background: transparent;
            border: 1px solid var(--rh-gray-light);
            color: var(--rh-white);
        }

        .btn-outline:hover {
            border-color: var(--rh-white);
        }

        /* Cards */
        .card {
            background: var(--rh-gray-dark);
            border: 1px solid var(--rh-gray);
            border-radius: 6px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .card h2 {
            font-size: 1.1rem;
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid var(--rh-gray);
        }

        /* Forms */
        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.4rem;
            font-size: 0.85rem;
            color: var(--rh-gray-light);
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 0.6rem 0.75rem;
            background: var(--rh-black);
            border: 1px solid var(--rh-gray);
            border-radius: 4px;
            color: var(--rh-white);
            font-family: inherit;
            font-size: 0.9rem;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--rh-blue);
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
        }

        /* Mode Selection */
        .mode-cards {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1.5rem;
            margin: 1.5rem 0;
        }

        .mode-card {
            background: var(--rh-gray-dark);
            border: 2px solid var(--rh-gray);
            border-radius: 8px;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .mode-card:hover {
            border-color: var(--rh-gray-light);
        }

        .mode-card.active {
            border-color: var(--rh-red);
            background: rgba(238, 0, 0, 0.1);
        }

        .mode-card h3 {
            font-size: 1.25rem;
            margin-bottom: 0.5rem;
        }

        .mode-card p {
            color: var(--rh-gray-light);
            font-size: 0.9rem;
        }

        .mode-card .icon {
            font-size: 2.5rem;
            margin-bottom: 1rem;
        }

        /* Results */
        .results-summary {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .result-box {
            background: var(--rh-gray);
            border-radius: 6px;
            padding: 1.25rem;
            text-align: center;
        }

        .result-box .value {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
        }

        .result-box .label {
            font-size: 0.8rem;
            color: var(--rh-gray-light);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .result-box.passed .value { color: var(--rh-green); }
        .result-box.failed .value { color: var(--rh-red); }

        /* Check Results List */
        .check-list {
            border: 1px solid var(--rh-gray);
            border-radius: 6px;
            overflow: hidden;
        }

        .check-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--rh-gray);
        }

        .check-item:last-child {
            border-bottom: none;
        }

        .check-item .icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            flex-shrink: 0;
        }

        .check-item.passed .icon {
            background: var(--rh-green);
        }

        .check-item.failed .icon {
            background: var(--rh-red);
        }

        .check-item .text {
            flex: 1;
            font-size: 0.9rem;
        }

        .check-item .category {
            font-size: 0.75rem;
            color: var(--rh-cyan);
            text-transform: capitalize;
        }

        /* Stats */
        .category-bars {
            margin-top: 1rem;
        }

        .category-bar {
            margin-bottom: 1rem;
        }

        .category-bar .header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.4rem;
            font-size: 0.9rem;
        }

        .category-bar .name {
            text-transform: capitalize;
        }

        .category-bar .pct {
            font-weight: 600;
        }

        .category-bar .pct.good { color: var(--rh-green); }
        .category-bar .pct.ok { color: var(--rh-orange); }
        .category-bar .pct.bad { color: var(--rh-red); }

        .progress-track {
            height: 8px;
            background: var(--rh-gray);
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.3s;
        }

        .progress-fill.good { background: var(--rh-green); }
        .progress-fill.ok { background: var(--rh-orange); }
        .progress-fill.bad { background: var(--rh-red); }

        /* Utilities */
        .hidden { display: none !important; }
        .text-center { text-align: center; }
        .mt-1 { margin-top: 1rem; }
        .mt-2 { margin-top: 2rem; }
        .mb-1 { margin-bottom: 1rem; }
        .mb-2 { margin-bottom: 2rem; }

        .loading {
            text-align: center;
            padding: 3rem;
            color: var(--rh-gray-light);
        }

        .alert {
            padding: 1rem;
            border-radius: 4px;
            margin-bottom: 1rem;
        }

        .alert-info {
            background: rgba(0, 102, 204, 0.2);
            border: 1px solid var(--rh-blue);
        }

        .alert-warning {
            background: rgba(240, 171, 0, 0.2);
            border: 1px solid var(--rh-orange);
        }

        /* Task Checkbox List */
        .task-checkbox-list {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid var(--rh-gray);
            border-radius: 4px;
        }

        .task-checkbox-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.6rem 0.75rem;
            border-bottom: 1px solid var(--rh-gray);
            cursor: pointer;
        }

        .task-checkbox-item:last-child {
            border-bottom: none;
        }

        .task-checkbox-item:hover {
            background: var(--rh-gray);
        }

        .task-checkbox-item input[type="checkbox"] {
            width: 16px;
            height: 16px;
            accent-color: var(--rh-red);
        }

        .task-checkbox-item .desc {
            flex: 1;
            font-size: 0.85rem;
        }

        .task-checkbox-item .cat {
            font-size: 0.75rem;
            color: var(--rh-cyan);
        }

        /* Welcome Screen */
        .welcome {
            text-align: center;
            padding: 4rem 2rem;
            max-width: 600px;
            margin: 0 auto;
        }

        .welcome h1 {
            font-size: 2rem;
            margin-bottom: 1rem;
        }

        .welcome p {
            color: var(--rh-gray-light);
            margin-bottom: 2rem;
            line-height: 1.6;
        }

        .welcome .actions {
            display: flex;
            gap: 1rem;
            justify-content: center;
        }

        /* Tab Navigation */
        .tabs {
            display: flex;
            border-bottom: 1px solid var(--rh-gray);
            margin-bottom: 1.5rem;
        }

        .tab {
            padding: 0.75rem 1.5rem;
            background: none;
            border: none;
            color: var(--rh-gray-light);
            cursor: pointer;
            font-family: inherit;
            font-size: 0.9rem;
            position: relative;
        }

        .tab:hover {
            color: var(--rh-white);
        }

        .tab.active {
            color: var(--rh-white);
        }

        .tab.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--rh-red);
        }

        /* Exam Running State */
        .exam-instructions {
            background: var(--rh-gray);
            padding: 1.5rem;
            border-radius: 6px;
            margin-bottom: 1.5rem;
        }

        .exam-instructions h3 {
            margin-bottom: 0.75rem;
        }

        .exam-instructions ul {
            margin-left: 1.5rem;
            color: var(--rh-gray-light);
            line-height: 1.8;
        }

        .actions-bar {
            display: flex;
            gap: 1rem;
            padding: 1rem;
            background: var(--rh-gray-dark);
            border-top: 1px solid var(--rh-gray);
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-left">
            <div class="logo">
                <div class="logo-icon">RH</div>
                <span>RHCSA Practice Labs</span>
            </div>
        </div>
        <div class="header-center">
            <div class="vm-status">
                <div class="vm-indicator">
                    <span class="dot" id="vm1-status"></span>
                    <span id="vm1-name">node1</span>
                </div>
                <div class="vm-indicator">
                    <span class="dot" id="vm2-status"></span>
                    <span id="vm2-name">node2</span>
                </div>
            </div>
            <div class="timer-display hidden" id="timer">03:00:00</div>
        </div>
        <div class="header-right">
            <button class="btn btn-outline" onclick="showView('setup')">Setup</button>
            <button class="btn btn-outline" onclick="showView('stats')">Statistics</button>
        </div>
    </header>

    <div class="main-container">
        <!-- Sidebar - Task List (shown during exam) -->
        <aside class="sidebar hidden" id="exam-sidebar">
            <div class="sidebar-header">
                <h2>Tasks</h2>
                <span class="task-count" id="task-count">0/0</span>
            </div>
            <div class="task-list" id="sidebar-task-list"></div>
        </aside>

        <!-- Main Content -->
        <main class="content">
            <!-- Welcome View -->
            <div class="content-body" id="view-welcome">
                <div class="welcome">
                    <h1>Red Hat Certified System Administrator</h1>
                    <p>Practice environment for RHCSA (EX200) certification exam.
                       Configure your virtual machines, then choose Practice mode to study specific topics
                       or Exam mode for a timed simulation.</p>
                    <div class="actions">
                        <button class="btn btn-primary" onclick="showView('setup')">Configure VMs</button>
                        <button class="btn btn-secondary" onclick="showView('mode-select')">Start Practice</button>
                    </div>
                </div>
            </div>

            <!-- Setup View -->
            <div class="content-body hidden" id="view-setup">
                <div class="card">
                    <h2>Virtual Machine Configuration</h2>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Node 1 Hostname</label>
                            <input type="text" id="node1" value="rhcsa1">
                        </div>
                        <div class="form-group">
                            <label>Node 1 IP Address</label>
                            <input type="text" id="node1_ip" placeholder="192.168.122.10">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Node 2 Hostname</label>
                            <input type="text" id="node2" value="rhcsa2">
                        </div>
                        <div class="form-group">
                            <label>Node 2 IP Address</label>
                            <input type="text" id="node2_ip" placeholder="192.168.122.11">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Root Password (for SSH)</label>
                            <input type="password" id="root_password" placeholder="VM root password">
                        </div>
                        <div></div>
                    </div>
                    <div class="mt-1">
                        <button class="btn btn-primary" onclick="saveConfig()">Save Configuration</button>
                        <button class="btn btn-secondary" onclick="testConnection()">Test Connection</button>
                    </div>
                    <div id="connection-result" class="mt-1"></div>
                </div>
                <div class="mt-2">
                    <button class="btn btn-success" onclick="showView('mode-select')">Continue to Practice</button>
                </div>
            </div>

            <!-- Mode Selection View -->
            <div class="content-body hidden" id="view-mode-select">
                <h1 class="mb-2">Select Mode</h1>
                <div class="mode-cards">
                    <div class="mode-card" onclick="selectMode('practice')">
                        <div class="icon">üìö</div>
                        <h3>Practice Mode</h3>
                        <p>Select specific tasks and topics.<br>No time limit.</p>
                    </div>
                    <div class="mode-card" onclick="selectMode('exam')">
                        <div class="icon">‚è±Ô∏è</div>
                        <h3>Exam Mode</h3>
                        <p>Random selection of 13-20 tasks.<br>3 hour time limit.</p>
                    </div>
                </div>
            </div>

            <!-- Practice Setup View -->
            <div class="content-body hidden" id="view-practice-setup">
                <div class="card">
                    <h2>Select Tasks to Practice</h2>
                    <div class="mb-1">
                        <button class="btn btn-secondary" onclick="selectAllTasks()">Select All</button>
                        <button class="btn btn-secondary" onclick="deselectAllTasks()">Clear</button>
                        <select id="category-filter" onchange="filterByCategory()" style="margin-left: 1rem; padding: 0.5rem; background: var(--rh-black); border: 1px solid var(--rh-gray); color: white; border-radius: 4px;">
                            <option value="">All Categories</option>
                        </select>
                    </div>
                    <div class="task-checkbox-list" id="task-checkbox-list">
                        <div class="loading">Loading tasks...</div>
                    </div>
                </div>
                <button class="btn btn-success" onclick="startPractice()">Start Practice</button>
                <button class="btn btn-secondary" onclick="showView('mode-select')">Back</button>
            </div>

            <!-- Exam Setup View -->
            <div class="content-body hidden" id="view-exam-setup">
                <div class="card">
                    <h2>Exam Simulation</h2>
                    <div class="alert alert-info">
                        <strong>Exam Rules:</strong> You will have 3 hours to complete randomly selected tasks.
                        Work on your VMs and submit when finished. All configurations must persist after reboot.
                    </div>
                    <div class="form-group" style="max-width: 200px;">
                        <label>Number of Tasks (13-20)</label>
                        <input type="number" id="exam-task-count" value="15" min="13" max="20">
                    </div>
                </div>
                <button class="btn btn-success" onclick="startExam()">Begin Exam</button>
                <button class="btn btn-secondary" onclick="showView('mode-select')">Back</button>
            </div>

            <!-- Exam Running View -->
            <div class="content-body hidden" id="view-exam-running">
                <div class="exam-instructions">
                    <h3>Instructions</h3>
                    <ul>
                        <li>Complete the tasks listed in the sidebar on your virtual machines</li>
                        <li>All configurations must persist after system reboot</li>
                        <li>Do not disable SELinux or firewalld (50 point penalty each)</li>
                        <li>Click "Submit for Grading" when finished or when time expires</li>
                    </ul>
                </div>
                <div id="current-task-detail">
                    <p style="color: var(--rh-gray-light);">Select a task from the sidebar to view details.</p>
                </div>
            </div>

            <!-- Results View -->
            <div class="content-body hidden" id="view-results">
                <h1 class="mb-2">Exam Results</h1>
                <div class="results-summary">
                    <div class="result-box" id="result-score-box">
                        <div class="value" id="result-score">0</div>
                        <div class="label">Points Earned</div>
                    </div>
                    <div class="result-box">
                        <div class="value" id="result-total">0</div>
                        <div class="label">Total Points</div>
                    </div>
                    <div class="result-box">
                        <div class="value" id="result-pct">0%</div>
                        <div class="label">Percentage</div>
                    </div>
                    <div class="result-box" id="result-status-box">
                        <div class="value" id="result-status">-</div>
                        <div class="label">Status</div>
                    </div>
                </div>
                <div class="card">
                    <h2>Task Results</h2>
                    <div class="check-list" id="check-results"></div>
                </div>
                <button class="btn btn-primary" onclick="showView('mode-select')">Try Again</button>
                <button class="btn btn-secondary" onclick="showView('stats')">View Statistics</button>
            </div>

            <!-- Statistics View -->
            <div class="content-body hidden" id="view-stats">
                <h1 class="mb-2">Performance Statistics</h1>
                <div class="results-summary" id="stats-summary">
                    <div class="loading">Loading statistics...</div>
                </div>
                <div class="card">
                    <h2>Areas to Improve</h2>
                    <div id="weak-areas"></div>
                </div>
                <div class="card">
                    <h2>Performance by Category</h2>
                    <div class="category-bars" id="category-stats"></div>
                </div>
                <button class="btn btn-secondary" onclick="showView('welcome')">Back to Home</button>
            </div>
        </main>
    </div>

    <!-- Actions Bar (shown during exam) -->
    <div class="actions-bar hidden" id="exam-actions">
        <button class="btn btn-success" onclick="submitExam()">Submit for Grading</button>
        <button class="btn btn-secondary" onclick="confirmAbandon()">Abandon Exam</button>
    </div>

    <script>
        // State
        let allTasks = [];
        let selectedTasks = [];
        let currentMode = null;
        let timerInterval = null;
        let examStartTime = null;
        const EXAM_DURATION = 3 * 60 * 60 * 1000; // 3 hours

        // View Management
        function showView(viewId) {
            document.querySelectorAll('.content-body').forEach(v => v.classList.add('hidden'));
            document.getElementById(`view-${viewId}`).classList.remove('hidden');

            // Hide exam UI elements when not in exam
            if (viewId !== 'exam-running') {
                document.getElementById('exam-sidebar').classList.add('hidden');
                document.getElementById('exam-actions').classList.add('hidden');
                document.getElementById('timer').classList.add('hidden');
            }

            // Load data for specific views
            if (viewId === 'practice-setup') loadTasks();
            if (viewId === 'stats') loadStats();
        }

        // Config
        async function loadConfig() {
            try {
                const res = await fetch('/api/config');
                const config = await res.json();
                document.getElementById('node1').value = config.node1 || 'rhcsa1';
                document.getElementById('node1_ip').value = config.node1_ip || '';
                document.getElementById('node2').value = config.node2 || 'rhcsa2';
                document.getElementById('node2_ip').value = config.node2_ip || '';
                document.getElementById('root_password').value = config.root_password || '';

                document.getElementById('vm1-name').textContent = config.node1 || 'node1';
                document.getElementById('vm2-name').textContent = config.node2 || 'node2';
            } catch (e) {
                console.error('Failed to load config:', e);
            }
        }

        async function saveConfig() {
            const config = {
                node1: document.getElementById('node1').value,
                node1_ip: document.getElementById('node1_ip').value,
                node2: document.getElementById('node2').value,
                node2_ip: document.getElementById('node2_ip').value,
                root_password: document.getElementById('root_password').value
            };

            await fetch('/api/config', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(config)
            });

            document.getElementById('vm1-name').textContent = config.node1;
            document.getElementById('vm2-name').textContent = config.node2;

            document.getElementById('connection-result').innerHTML =
                '<div class="alert alert-info">Configuration saved.</div>';
        }

        async function testConnection() {
            const result = document.getElementById('connection-result');
            result.innerHTML = '<div class="loading">Testing connectivity...</div>';

            try {
                const res = await fetch('/api/test-connection', { method: 'POST' });
                const data = await res.json();

                document.getElementById('vm1-status').className = 'dot ' + (data.node1 ? 'ok' : 'fail');
                document.getElementById('vm2-status').className = 'dot ' + (data.node2 ? 'ok' : 'fail');

                result.innerHTML = `
                    <div class="alert ${data.node1 && data.node2 ? 'alert-info' : 'alert-warning'}">
                        Node 1: ${data.node1 ? '‚úì Connected' : '‚úó Failed'}<br>
                        Node 2: ${data.node2 ? '‚úì Connected' : '‚úó Failed'}
                    </div>
                `;
            } catch (e) {
                result.innerHTML = '<div class="alert alert-warning">Connection test failed.</div>';
            }
        }

        // Tasks
        async function loadTasks() {
            try {
                const res = await fetch('/api/tasks');
                allTasks = await res.json();

                // Populate category filter
                const categories = [...new Set(allTasks.map(t => t.category))].sort();
                const filter = document.getElementById('category-filter');
                filter.innerHTML = '<option value="">All Categories</option>' +
                    categories.map(c => `<option value="${c}">${c}</option>`).join('');

                renderTaskCheckboxes(allTasks);
            } catch (e) {
                console.error('Failed to load tasks:', e);
            }
        }

        function renderTaskCheckboxes(tasks) {
            const list = document.getElementById('task-checkbox-list');
            list.innerHTML = tasks.map(t => `
                <label class="task-checkbox-item">
                    <input type="checkbox" value="${t.id}">
                    <span class="desc">${t.id}: ${t.description}</span>
                    <span class="cat">${t.category}</span>
                </label>
            `).join('');
        }

        function filterByCategory() {
            const cat = document.getElementById('category-filter').value;
            const filtered = cat ? allTasks.filter(t => t.category === cat) : allTasks;
            renderTaskCheckboxes(filtered);
        }

        function selectAllTasks() {
            document.querySelectorAll('#task-checkbox-list input').forEach(cb => cb.checked = true);
        }

        function deselectAllTasks() {
            document.querySelectorAll('#task-checkbox-list input').forEach(cb => cb.checked = false);
        }

        function getSelectedTaskIds() {
            return [...document.querySelectorAll('#task-checkbox-list input:checked')].map(cb => cb.value);
        }

        // Mode Selection
        function selectMode(mode) {
            currentMode = mode;
            showView(mode === 'practice' ? 'practice-setup' : 'exam-setup');
        }

        // Start Practice
        function startPractice() {
            const ids = getSelectedTaskIds();
            if (ids.length === 0) {
                alert('Please select at least one task.');
                return;
            }
            selectedTasks = ids;
            startExamView(allTasks.filter(t => ids.includes(t.id)), false);
        }

        // Start Exam
        async function startExam() {
            const count = parseInt(document.getElementById('exam-task-count').value) || 15;

            try {
                const res = await fetch(`/api/random-tasks?count=${count}`);
                const tasks = await res.json();
                selectedTasks = tasks.map(t => t.id);
                startExamView(tasks, true);
            } catch (e) {
                alert('Failed to generate exam tasks.');
            }
        }

        function startExamView(tasks, timed) {
            // Show exam UI
            showView('exam-running');
            document.getElementById('exam-sidebar').classList.remove('hidden');
            document.getElementById('exam-actions').classList.remove('hidden');

            if (timed) {
                document.getElementById('timer').classList.remove('hidden');
                startTimer();
            }

            // Populate sidebar
            const sidebar = document.getElementById('sidebar-task-list');
            sidebar.innerHTML = tasks.map((t, i) => `
                <div class="task-item" data-id="${t.id}" onclick="showTaskDetail('${t.id}')">
                    <div class="task-number">${i + 1}</div>
                    <div class="task-info">
                        <div class="task-title">${t.description}</div>
                        <div class="task-category">${t.category}</div>
                    </div>
                </div>
            `).join('');

            document.getElementById('task-count').textContent = `0/${tasks.length}`;

            // Show first task
            if (tasks.length > 0) showTaskDetail(tasks[0].id);
        }

        function showTaskDetail(taskId) {
            const task = allTasks.find(t => t.id === taskId);
            if (!task) return;

            // Update sidebar selection
            document.querySelectorAll('.task-item').forEach(el => {
                el.classList.toggle('active', el.dataset.id === taskId);
            });

            document.getElementById('current-task-detail').innerHTML = `
                <div class="card">
                    <h2>${task.id}</h2>
                    <p style="font-size: 1.1rem; line-height: 1.6;">${task.description}</p>
                    <p class="mt-1" style="color: var(--rh-cyan);">Category: ${task.category}</p>
                </div>
            `;
        }

        // Timer
        function startTimer() {
            examStartTime = Date.now();
            const timerEl = document.getElementById('timer');

            timerInterval = setInterval(() => {
                const elapsed = Date.now() - examStartTime;
                const remaining = Math.max(0, EXAM_DURATION - elapsed);

                if (remaining <= 0) {
                    stopTimer();
                    submitExam();
                    return;
                }

                const hrs = Math.floor(remaining / 3600000);
                const mins = Math.floor((remaining % 3600000) / 60000);
                const secs = Math.floor((remaining % 60000) / 1000);

                timerEl.textContent = `${hrs.toString().padStart(2, '0')}:${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;

                timerEl.classList.remove('warning', 'critical');
                if (remaining < 300000) timerEl.classList.add('critical');
                else if (remaining < 900000) timerEl.classList.add('warning');
            }, 1000);
        }

        function stopTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
        }

        // Submit
        async function submitExam() {
            stopTimer();
            const duration = examStartTime ? Math.floor((Date.now() - examStartTime) / 1000) : null;

            document.getElementById('view-exam-running').innerHTML = '<div class="loading">Grading your work...</div>';

            try {
                const res = await fetch('/api/run', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ mode: currentMode, tasks: selectedTasks })
                });

                const result = await res.json();

                if (result.error) {
                    alert('Grading error: ' + result.error);
                    showView('mode-select');
                    return;
                }

                // Save result
                await fetch('/api/results', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ...result, mode: currentMode, duration_seconds: duration })
                });

                displayResults(result);
            } catch (e) {
                alert('Failed to submit exam.');
                showView('mode-select');
            }
        }

        function confirmAbandon() {
            if (confirm('Are you sure you want to abandon this exam? Your progress will be lost.')) {
                stopTimer();
                showView('mode-select');
            }
        }

        function displayResults(result) {
            document.getElementById('exam-sidebar').classList.add('hidden');
            document.getElementById('exam-actions').classList.add('hidden');
            document.getElementById('timer').classList.add('hidden');

            showView('results');

            const pct = Math.round((result.score / result.total) * 100);
            document.getElementById('result-score').textContent = result.score;
            document.getElementById('result-total').textContent = result.total;
            document.getElementById('result-pct').textContent = pct + '%';
            document.getElementById('result-status').textContent = result.passed ? 'PASSED' : 'FAILED';

            const scoreBox = document.getElementById('result-score-box');
            const statusBox = document.getElementById('result-status-box');
            scoreBox.className = 'result-box ' + (result.passed ? 'passed' : 'failed');
            statusBox.className = 'result-box ' + (result.passed ? 'passed' : 'failed');

            document.getElementById('check-results').innerHTML = result.checks.map(c => `
                <div class="check-item ${c.passed ? 'passed' : 'failed'}">
                    <div class="icon">${c.passed ? '‚úì' : '‚úó'}</div>
                    <div class="text">${c.check}</div>
                    <div class="category">${c.category}</div>
                </div>
            `).join('');
        }

        // Stats
        async function loadStats() {
            try {
                const res = await fetch('/api/stats');
                const stats = await res.json();

                document.getElementById('stats-summary').innerHTML = `
                    <div class="result-box">
                        <div class="value">${stats.total_attempts}</div>
                        <div class="label">Attempts</div>
                    </div>
                    <div class="result-box">
                        <div class="value">${stats.passed}</div>
                        <div class="label">Passed</div>
                    </div>
                    <div class="result-box">
                        <div class="value">${stats.pass_rate}%</div>
                        <div class="label">Pass Rate</div>
                    </div>
                `;

                document.getElementById('weak-areas').innerHTML = stats.weak_areas.length ?
                    stats.weak_areas.map(w => {
                        const cls = w.percentage >= 70 ? 'good' : w.percentage >= 50 ? 'ok' : 'bad';
                        return `
                            <div class="category-bar">
                                <div class="header">
                                    <span class="name">${w.category.replace(/-/g, ' ')}</span>
                                    <span class="pct ${cls}">${w.percentage}%</span>
                                </div>
                                <div class="progress-track">
                                    <div class="progress-fill ${cls}" style="width: ${w.percentage}%"></div>
                                </div>
                            </div>
                        `;
                    }).join('') : '<p style="color: var(--rh-gray-light)">Complete some practice sessions to see weak areas.</p>';

                const sortedCats = Object.entries(stats.categories).sort((a, b) => b[1].percentage - a[1].percentage);
                document.getElementById('category-stats').innerHTML = sortedCats.length ?
                    sortedCats.map(([cat, s]) => {
                        const cls = s.percentage >= 70 ? 'good' : s.percentage >= 50 ? 'ok' : 'bad';
                        return `
                            <div class="category-bar">
                                <div class="header">
                                    <span class="name">${cat.replace(/-/g, ' ')}</span>
                                    <span class="pct ${cls}">${s.percentage}%</span>
                                </div>
                                <div class="progress-track">
                                    <div class="progress-fill ${cls}" style="width: ${s.percentage}%"></div>
                                </div>
                            </div>
                        `;
                    }).join('') : '<p style="color: var(--rh-gray-light)">No data yet.</p>';
            } catch (e) {
                console.error('Failed to load stats:', e);
            }
        }

        // Init
        loadConfig();
    </script>
</body>
</html>
